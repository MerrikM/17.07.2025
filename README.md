# Тестовое задание: Junior Go-разработчик

## Описание проекта

Это тестовое задание для позиции Junior Go-разработчика. Проект представляет собой REST API сервер, реализованный на языке Go с использованием фреймворка Chi. Сервер позволяет создавать задачи для архивации файлов в ZIP, добавлять до 3 файлов в каждую задачу и получать статус задачи. Основные особенности:

- **Ограничение на задачи**: одновременно может быть не более 3 активных задач (статусы "создана" или "выполняется").
- **Ограничение на файлы**: каждая задача может содержать до 3 файлов с поддерживаемыми расширениями (`.jpg`, `.jpeg`, `.png`, `.webp`, `.pdf`).
- **Конкурентность**: API безопасно обрабатывает конкурентные запросы благодаря мьютексам и каналам.
- **Swagger-документация**: API документировано с помощью Swagger-аннотаций, доступных по эндпоинту `/swagger/*`.

## Технологии

- **Язык**: Go
- **Фреймворк**: Chi (роутинг)
- **Swagger**: для документации API
- **Конфигурация**: YAML-файл (`config.yaml`)
- **Логирование**: встроенный `log`
- **Конкурентность**: `sync.Mutex` и каналы для управления задачами и файлами

## API-эндпоинты

API доступно по базовому пути `/api-tasks`. Все эндпоинты принимают и возвращают данные в формате JSON.

### 1. Создание новой задачи

- **Эндпоинт**: `POST /api-tasks/create-task`
- **Описание**: Создаёт новую задачу для архивации файлов в ZIP-архив. Возвращает ID созданной задачи.
- **Тело запроса**:
  ```json
  {
    "ZipArchivePath": "string",
    "ZipArchiveName": "string"
  }
  ```
  - `ZipArchivePath`: путь для сохранения ZIP-архива (например, `/tmp`).
  - `ZipArchiveName`: имя ZIP-архива (например, `archive.zip`).
- **Успешный ответ (200)**:
  ```json
  {
    "Message": "id вашей задачи: ",
    "TaskID": 1
  }
  ```
- **Ошибки**:
  - `400 Bad Request`: неверный формат JSON.
  - `503 Service Unavailable`: сервер занят (достигнут лимит в 3 активные задачи).
- **Пример**:
  ```bash
  curl -X POST http://localhost:8080/api-tasks/create-task \
       -H "Content-Type: application/json" \
       -d '{"ZipArchivePath": "/tmp", "ZipArchiveName": "archive.zip"}'
  ```

### 2. Получение статуса задачи

- **Эндпоинт**: `GET /api-tasks/get`
- **Описание**: Возвращает статус задачи и, если задача завершена (добавлено 3 файла), ссылку на ZIP-архив.
- **Параметры запроса**:
  - `task-id` (query): ID задачи (целое число).
- **Успешный ответ (200)**:
  - Для активной задачи:
    ```json
    {
      "TaskID": 1,
      "Status": "выполняется"
    }
    ```
  - Для завершённой задачи (3 файла):
    ```json
    {
      "TaskID": 1,
      "Status": "завершена",
      "ArchiveLink": "/tmp/archive.zip"
    }
    ```
- **Ошибки**:
  - `400 Bad Request`: некорректный ID задачи или задача не найдена.
- **Пример**:
  ```bash
  curl http://localhost:8080/api-tasks/get?task-id=1
  ```

### 3. Добавление файла к задаче
#### Предисловие: когда вставляете ссылку на скачивание файла, обратите внимание, чтобы ссылка оканчивалась расширением файла и после нее ничего не было. Пример валидной ссылки: http://example.com/file.jpg
- **Эндпоинт**: `POST /api-tasks/add-file-to-task`
- **Описание**: Добавляет файл в ZIP-архив задачи. Поддерживает до 3 файлов на задачу с расширениями `.jpg`, `.jpeg`, `.png`, `.webp`, `.pdf`.
- **Тело запроса**:
  ```json
  {
    "TaskID": 1,
    "FileURL": "http://example.com/file.jpg",
    "FileName": "file.jpg"
  }
  ```
  - `TaskID`: ID задачи.
  - `FileURL`: URL файла для загрузки.
  - `FileName`: Имя файла в архиве.
- **Успешный ответ (200)**:
  ```json
  {
    "Message": "файлы успешно добавлен к вашей задаче",
    "TaskID": 1
  }
  ```
- **Ошибки**:
  - `400 Bad Request`: неверный формат JSON, неподдерживаемое расширение файла, превышен лимит файлов, задача не найдена или уже завершена.
- **Пример**:
  ```bash
  curl -X POST http://localhost:8080/api-tasks/add-file-to-task \
       -H "Content-Type: application/json" \
       -d '{"TaskID": 1, "FileURL": "http://example.com/file.jpg", "FileName": "file.jpg"}'
  ```

## Установка и запуск

### Требования

- Go 1.18 или выше
- Установленные зависимости:
  ```bash
  go get github.com/go-chi/chi/v5
  go get github.com/swaggo/http-swagger
  go get gopkg.in/yaml.v3
  ```

### Конфигурация

1. Измените файл `config.yaml` в корне проекта:
   ```yaml
   server:
     port: 8080
     basePath: /api-tasks
   ```
   - `port`: порт сервера (по умолчанию `8080`).
   - `basePath`: базовый путь для API (по умолчанию `/api-tasks`).

2. Убедитесь, что директория для хранения ZIP-архивов (например, `/tmp`) существует и доступна для записи.

### Запуск

1. Скомпилируйте и запустите сервер:
   ```bash
   go run main.go
   ```
2. Сервер будет доступен по адресу `http://localhost:8080`.

3. Откройте Swagger-документацию в браузере:
   ```
   http://localhost:8080/swagger/
   ```

## Структура проекта

- `main.go`: точка входа, настройка сервера и маршрутов.
- `config/`: конфигурация и загрузка конфигурации из `config.yaml`, а также настройка сервера.
- `service/task_service.go`: бизнес-логика для управления задачами и файлами.
- `handler/task_handler.go`: обработчики HTTP-запросов и структуры (`TaskStatusResponse`, `CreateTaskRequest`, `AddFileToTaskRequest`, `CreateTaskResponse`, `AddFileToTaskResponse`).
- `internal/model/task.go`: структура `Task`.
- `internal/util/util.go`: вспомогательные функции, включая `DownloadAndAddToZip` для загрузки и добавления файлов в ZIP.

## Особенности реализации

- **Конкурентность**: Используются мьютексы (`sync.Mutex`) и каналы (`tasksSlot`, `FileCountChannel`) для безопасной работы с задачами и файлами в конкурентной среде.
- **Ограничения**:
  - Максимум 3 активные задачи одновременно (контролируется каналом `tasksSlot`).
  - Максимум 3 файла на задачу, с ограничением на одновременную обработку (контролируется `FileCountChannel`).
- **Сохранение завершённых задач**: Завершённые задачи остаются в памяти, чтобы их статус и данные можно было получить через `GET /api-tasks/get`.
- **Тайм-ауты**: Все запросы ограничены тайм-аутом в 4 секунды для предотвращения зависаний.

## Ограничения и возможные улучшения

- **Производительность**: Загрузка больших файлов через `util.DownloadAndAddToZip` может быть медленной. Возможна оптимизация с помощью тайм-аутов или асинхронной обработки.
- **Очистка памяти**: Завершённые задачи остаются в памяти. Можно добавить метод для их удаления (например, `DeleteTask`).
- **Логирование**: Текущее логирование минимально. Для продакшена стоит добавить структурированное логирование (например, с `zap`).
- **Тестирование**: Рекомендуется добавить юнит-тесты для `service` и `handler`, а также интеграционные тесты для API.

---

Это было тестовое задание выполнено в рамках отбора на позицию Junior Go-разработчик.
